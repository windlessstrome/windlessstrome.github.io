<!DOCTYPE html>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta http-equiv="Content-Security-Policy" content="default-src 'self';">
<html>

<head>
    <title>Mitel Connect</title>

    <link rel="stylesheet" href="./network-status-indicator.css">
    <link rel="stylesheet" href="./upgrade.css">
    <script src="./script/jquery-3.5.1.min.js"></script>
    <script src="./script/network-status.js"></script>
    <script src="./script/base-url.js"></script>
    <script src="./script/auto-upgrade.js"></script>

    <script type="text/javascript">
        var queryParam = window.location.search;
        if (window.opener && window.opener.location.href !== window.location.href && (queryParam.includes('?code=') || queryParam.includes('error_description'))) {
            // With AuthPortal integration we are loading the AuthPoral(AP) page is a iframe, when AP redirects
            // back to the app we need to stop creating the app and send this message to main window from where
            // AP login ws initiaed. if you are here then the code is really running in iframe
            // refere docuentation here for the postMessage
            // https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage

            window.opener.postMessage(window.location.href, 'chrome-extension://manhattan/index.html');
            window.close();
        }
        // create Endo and get package.json before running
        // steal so these properties are available to canjs constructors
        // run prior to setup.js
        window.Endo = window.Endo || {};
        window.Endo.pkg = nw.require('./package.json');
        // TESTEE_URL is set by testee when running unit test. With nwjs 0.13+ the --url arg is ignored
        // if app.nw/package.nw is present, which is the case for release builds, and in cases where --url
        // is used the window will not have access to node since package.json with node_remote is not parsed in
        // that case.
        if (nw.process.env.TESTEE_URL) {
            if (nw.process.env.SHOW_DEV_TOOLS) { // helpful to debug unit tests.
                nw.Window.get().showDevTools();
            }
            console.log('redirecting to testee url:' + nw.process.env.TESTEE_URL);
            window.location.href = nw.process.env.TESTEE_URL;
        }
        var scriptForNewRelic = document.createElement('script');
        // Notice that inside the if statement the value of window.localStorage.getItem('SendToNewRelic') is of string type
        if (window.localStorage.getItem('SendToNewRelic') === "false") {
            scriptForNewRelic.setAttribute('src', 'vendor/newrelic/newrelic-dummy.js');
        } else {
            scriptForNewRelic.setAttribute('src', 'vendor/newrelic/newrelic.js');
        }
        document.head.appendChild(scriptForNewRelic);
    </script>
    <script src="./node_modules/webcomponentsjs/webcomponents-lite.min.js"></script>
    <link rel="import" href="./node_modules/shor-avatar/shor-avatar.html">
</head>

<body>
    <script src="./steal/steal.production.js" config="./stealconfig.js" main="./endo/endo" bundles-path="."></script>
    <!-- To test application runing with alpha and production or from \web\endo\build\production comment above line and un-comment this line -->
    <!-- <script src="./steal/steal.production.js" config="./stealconfig.js" main="endo/endo" bundles-path="."></script> -->

    <script type="text/javascript">
        var win = nw.Window.get();
        var developerConfig = window.Endo.pkg.developer;

        var formatAndLogStacktrace = function (err) {
            var message = 'no err.message';
            var stack = 'no err.stack';
            var stackLines = [];
            if (err.message) {
                message = err.message;
            } else if (typeof err === 'string') {
                message = err;
            }
            if (err.stack) {
                stack = err.stack;
                stackLines = stack.split('\n');
            }
            console.error('ST-ERROR: ', message);
            console.error('Backtrace:');
            for (var i = 0; i < stackLines.length; i++) {
                console.error(stackLines[i]);
            }
            return { message: message, stack: stack };
        };

        if (window.process && developerConfig.throwExceptions !== true) {
            // If there is an uncaught node.js bug, the node-webkit crashes to to cloud screen,
            // but from there we can't log the error to the manhattan log file.  So instead, we
            // catch it ourselves, log the error, and then transition to an error screen.
            nw.process.removeAllListeners('uncaughtException');
            nw.process.on('uncaughtException', function (err) {
                var error = formatAndLogStacktrace(err);

                if (error.message === 'illegal access') {
                    console.error('Unrecoverable error detected, reloading the application!');
                    window.location.reload();
                }
                else {
                    // Transition to the crash page.
                    var crashPage = 'data:text/html;charset=utf-8,<html><body><h1>&#9785;</h1><h1>%message%</h1><h2>%backtrace%</h2></body></html>';
                    error.stack = error.stack.replace('\n', '<br/>');
                    crashPage = crashPage.replace('%message%', error.message).replace('%backtrace%', error.stack);
                    window.location.href = crashPage;
                }
            });
        } else {
            nw.process.removeAllListeners('uncaughtException');
            nw.process.on('uncaughtException', function (err) {
                var error = formatAndLogStacktrace(err);

                if (error.message === 'illegal access') {
                    console.error('Unrecoverable error detected, reloading the application!');
                    window.location.reload();
                }

                window.NREUM && window.NREUM.noticeError(err);
                return false;
            });
        }

        if (developerConfig.showDevToolsOnStartup) {
            // if this is the main window, show dev tools right away
            win.showDevTools();
            win.removeAllListeners('shellWindowOpened');
            win.on('shellWindowOpened', function (win) {
                win.showDevTools();
            });
        }
    </script>
    <iframe style="display: none;" name="presenter"></iframe>
    <div id="network-status" class='no-connection-img'></div>
    <div id="reload-popup" class="popup">
        <div id="error-msg" class="text">Something Went Wrong. Please Reload!</div>
        <div id="reload-button" class="button">Reload</div>
    </div>
    <div id="spinner" class="loader"></div>
</body>

</html>